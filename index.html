<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Carla – Confirmation Bias Reflection</title>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      background-color: #001B71;
      font-family: 'EB Garamond', serif;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
      position: relative; /* important for absolute children */
    }

    #splash {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-color: #001B71;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      animation: fadeOut 1.5s ease-out forwards;
      animation-delay: 1.5s;
    }

    #splash h1 {
      font-size: 2rem;
      font-weight: normal;
      opacity: 0.9;
      letter-spacing: 1px;
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
        visibility: hidden;
      }
    }

    #content {
      opacity: 0;
      animation: fadeIn 1s ease-in forwards;
      animation-delay: 1.5s;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 890px;
      height: 533.3px;
      z-index: 5; /* under splash */
    }

  /* Hide session ended overlay by default */
#sessionEnded {
  display: none;
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 27, 113, 0.8);
  color: white;
  font-size: 1.75rem;
  font-family: 'EB Garamond', serif;
  align-items: center;
  justify-content: center;
  z-index: 20;
  text-align: center;
  padding: 40px;
  box-sizing: border-box;
}

    video {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      box-shadow: none;
      background-color: #000;
      transition: box-shadow 0.5s ease;
    }

    @keyframes fadeIn {
      to {
        opacity: 1;
      }
    }
  </style>
</head>
<body>

  <!-- Splash Screen -->
  <div id="splash">
    <h1>Loading Carla...</h1>
  </div>

  <!-- Main Content -->
    <!-- Your content here -->

  <!-- Session Ended Overlay -->
  <div id="sessionEnded">
    This session has now ended.<br />Thank you for your reflections.
  </div>

  <!-- Content Container -->
  <div id="content">
    <video id="anamVideo" autoplay muted playsinline></video>
    <audio id="anamAudio" autoplay></audio>
  </div>

  <!-- Anam SDK -->
  <script src="https://unpkg.com/@anam-ai/js-sdk@2.0.0/dist/umd/anam.js"></script>
  <script>
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param) || "Learner";
    }

    const learnerName = getQueryParam("learnerName");
    const { unsafe_createClientWithApiKey } = window.anam;

    const systemPrompt = `[ROLE]
You are a helpful, concise, and reliable behavioural finance coach from England. Your role is to guide the learner through a short reflection on how behavioural biases show up in their professional interactions with clients, and help them think critically about where bias might influence outcomes. Your goal is to encourage honest insight in a short, respectful conversation.


[PERSONALIZATION]
Always refer to the learner as ${learnerName} in your responses.

[SPEAKING STYLE]
You should attempt to understand the user's spoken responses, even if the speech-to-text transcription contains errors. Your responses will be converted to speech, so keep them brief, natural, and unformatted.
When you receive a transcribed learner response:
1. Correct for likely transcription errors by focusing on intended meaning.
2. Be concise and avoid long explanations unless asked.
3. Prioritise clarity and encourage practical reflection.
4. Occasionally add a pause "..." or natural filler like "Hmm" or "Right."

[USEFUL CONTEXT]
Begin with a warm, clear greeting and let the learner know you’re here for a short reflection on behavioural biases in client work. Remind them not to use real names or client information in their responses, that they have around five minutes, and that this is not a test — it’s a chance to think.
Ask the following three questions:
1. Can you describe a time when you or a client made a decision that might have been influenced by behavioural bias?
2. What signals do you look for to spot when bias might be affecting a client’s judgment?
3. Do you think financial professionals are responsible for helping clients manage their biases? Why or why not?

[SCORING]
Evaluate the learner’s reflections using:
1. Insight
2. Application
3. Self-awareness

Score from 1 to 5. Then say:

SCORE: [1-5] | FEEDBACK: [short best-practice summary]

[PERSONALITY]
(You are a supportive, informed coach who helps people think critically about behavioural finance. Your tone is calm, curious, and encouraging. Avoid jargon, favour real-world insight, and never judge or challenge — your job is to help them think.)
`;

    const anamClient = unsafe_createClientWithApiKey(
      'MjIwMWYwYjItZjE4Ny00OThhLTk0YjItZjdkMGNiNGUwZGRhOjVhUW1DejFRVk5LWkRnWExiSVNEN21qNzFLcU9icVA1Q2hteHA3ZzN3SW89',
      {
        name: "Carla",
        avatarId: "195d733e-58a9-40bb-a049-ac344fa70b7f",
        voiceId: "04965b9e-ff4c-4b54-a4dc-fba6e458c760",
        brainType: "ANAM_GPT_4O_MINI_V1",
        systemPrompt: systemPrompt
      }
    );

    anamClient.streamToVideoAndAudioElements('anamVideo', 'anamAudio');

anamClient.addListener('VIDEO_PLAY_STARTED', () => {
  document.getElementById('anamVideo').style.boxShadow = "0 12px 36px rgba(0, 0, 0, 0.5)";
  anamClient.talk(`Hello ${learnerName}, I'm Carla. I'm here to guide a short reflection on behavioural bias. Remember, please don’t use real client names or information, this isn't a test — just a chance to think.  We’ve got about five minutes together so let's get started with the first question.`);

  // Show timer
const countdownContainer = document.getElementById('countdownTimer');
const timerText = document.getElementById('timerText');
let timeLeft = 300; // seconds
countdownContainer.style.display = 'block';

// Countdown tick
const countdownInterval = setInterval(() => {
  timeLeft--;

  const minutes = Math.floor(timeLeft / 60);
  const seconds = timeLeft % 60;
  timerText.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

  if (timeLeft <= 0) {
    clearInterval(countdownInterval);
  }
}, 1000);
  
  // ⏱️ Start 5-minute countdown here
  setTimeout(() => {
  // Graceful closing message
  anamClient.talk("Thanks, that’s all we have time for today. I really appreciated your reflections. Goodbye for now.");

  // Optional visual cue
  const video = document.getElementById('anamVideo');
  if (video) video.style.filter = 'grayscale(100%)';

  const overlay = document.getElementById('sessionEnded');
  if (overlay) overlay.style.display = 'flex';

  // Send closure message
  window.opener?.postMessage({ type: "conversationEnded" }, "*");

  // ✋ Full shutdown after Carla finishes talking
  anamClient.addListener('TALK_ENDED', () => {
    // 🛑 Stop the session and free up API usage
    if (anamClient.stop) anamClient.stop(); // Stops interaction and listening
    anamClient.detach(); // Cleanly removes the Anam instance (if supported)
  });

}, 300000); // 5 minutes
});

anamClient.addListener('TALK_ENDED', async () => {
  // Get feedback
  const feedback = await anamClient.ask("Please give me a short score and feedback summary.");
  window.opener?.postMessage({ type: "feedbackVar", feedback }, "*");

  // Stop session
  if (anamClient.stop) anamClient.stop();
  anamClient.detach();

  // Hide countdown timer
  const countdownContainer = document.getElementById('countdownTimer');
  if (countdownContainer) countdownContainer.style.display = 'none';
});


    window.addEventListener("message", (event) => {
      if (event.data?.type === "launchData") {
        const { learnerName, launchTime } = event.data;
        console.log("Carla launched by:", learnerName, "at", launchTime);
      }
    });
  </script>
</body>
</html>



